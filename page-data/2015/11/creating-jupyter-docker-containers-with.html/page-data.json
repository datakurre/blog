{"componentChunkName":"component---src-templates-blog-post-js","path":"/2015/11/creating-jupyter-docker-containers-with.html/","result":{"data":{"site":{"siteMetadata":{"title":"Asko Soukka","author":"Asko Soukka"}},"markdownRemark":{"id":"06fc14b6-c463-5df7-b1c3-5af27cc4309c","fields":{"slug":"/2015/11/creating-jupyter-docker-containers-with.html/"},"excerpt":"Jupyter is the new name and brand for an awesome\ninteractive data science programming scratchpad previously known as\niPython Notebook. While there are plenty of…","html":"<p><a href=\"http://jupyter.org/\">Jupyter</a> is the new name and brand for an awesome\ninteractive data science programming scratchpad previously known as\niPython Notebook. While there are plenty of pre-built <a href=\"https://github.com/jupyter/docker-demo-images\">Docker\nimages</a>\n<a href=\"https://github.com/jupyter/docker-stacks\">available</a> for Jupyter, for\ncustomized images, I’m tempted to use <a href=\"https://nixos.org/nix/\">Nix</a>.</p>\n<p>Here I describe approach for the following gists creating</p>\n<ul>\n<li><a href=\"https://gist.github.com/datakurre/49b6fbc4bafdef029183\">R-kernel Jupyter notebook environment and Docker container with\nNix</a></li>\n<li><a href=\"https://gist.github.com/datakurre/a26e0d173fb67d9bb145\">Multi-kernel Jupyter notebook environment and Docker container with\nNix</a>.</li>\n</ul>\n<p><strong>Note:</strong> Because these Jupyter notebook configurations are build with\nNix, their configuration is immutable and it’s not possible for the\nuser to install any additional packages directly from a notebook.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/af49083b246a02456a27518dabb58d3a/17602/jupyter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 104.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsSAAALEgHS3X78AAADLUlEQVQ4y31US28jRRCOxI3fxAFu/ATO3JH4ARw4wAVWCLQSj0Qmi6UNIHajRCSyNtGihERe1vF4xvgxnpc9D3vsefV093jenjFlm2wW7y6fSq2e7vmqvqrq7h1CYoJTw9YVU1YkWRAlWZOZUWtoqLzEC4poOy6i2KMoTpKVpelqXGMnz4vlcqkMFYZlBFHkmabc7XSaz+Ret9e7UcSOBh4GbXnUxaYZeB6dTcl0GobhirxcI03ScB6meT6fTrCuU92gpkmNMdY0rGtE14luIE31VNUbjcDCKHqJnKYJIM/xUHEEwRHBRFsQbGHgDHiL71sD3pEle8CDwe48Tu7IIIMSmiSpp44sWbIk2ZJFeyjb4GuoIIhvGL6hI1Vdxx/NN5HLsgTy1DT/7reHxrDf60uSBGNf5GVV5Lg2z/ME8pyMKdQ2SaP4DreRg9RFyEG257o+8jHG8/kc5BBCAkrTIEgwTuM4B2RZfotbMlm6DpRzYlmWYYxpEMDiRtT/4F8ypQQhLwgCjH3s+4RgBN8Iua7reS7MIL7tOMHa6R25yBdlUUC1oVVQhXCFCCbJ6iQkkGG0BjQDNtIs+w85dJ3Y94H/Jm2gfW3lG2W/jHmYRVG++rl81VH5evJmHQ5KvT5u3JiaRhBJJmZw8ceozU5n06Aoyhf8xaIIw2xny+toiH79uXN9rXPs9OSge/KI/+pe/f7Xfz19Is9Mqql4faIyc0Lj6BXy1eXop0rr/FypHQ7efevzTz445DrWn5fqTWOM/fjqUpUEt3YqMk0ThGyTG8+N3W8bjx/1blqz6nfMwR7b5mZtbtrt2Z4Xsoz5417rt186tjXfynlF1jW8X2G++fTii4/Pjg7546PBwyr3oNJqNk3DpC3OOj0RK7uMoZPtam9qphvko/cfvvP2Z/u7zOnv4tmZ8sP3jYtLde/LevUBd3wsHD3ms2zxmlZBJoQkYxk9OeiA2vPz4dW1UX823q+wH75XvX+vXqvJnhttlG63ipKkus8iFG0c+X7cYmcsNxsM3A43S5NF6/nkaU3eJt++CgtwnGdFsSijMFvkBVxzuFcvvMOzJfSdTYH+ASBefVsjfbVRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image\"\n        title=\"image\"\n        src=\"/static/af49083b246a02456a27518dabb58d3a/fcda8/jupyter.png\"\n        srcset=\"/static/af49083b246a02456a27518dabb58d3a/12f09/jupyter.png 148w,\n/static/af49083b246a02456a27518dabb58d3a/e4a3f/jupyter.png 295w,\n/static/af49083b246a02456a27518dabb58d3a/fcda8/jupyter.png 590w,\n/static/af49083b246a02456a27518dabb58d3a/17602/jupyter.png 597w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Usage</h2>\n<p>With <code>nix-shell</code> (unless you are on a mac):</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\">\n      <pre class=\" cm-s-solarized\"><code><span>$ git clone https://gist.github.com/datakurre/49b6fbc4bafdef029183\n$ cd 49b6fbc4bafdef029183\n$ nix-shell --run \"jupyter notebook\"</span></code></pre>\n    </div>\n<p>With <a href=\"https://docker.com/\">Docker</a> (works also on a mac):</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\">\n      <pre class=\" cm-s-solarized\"><code><span>$ git clone https://gist.github.com/datakurre/49b6fbc4bafdef029183\n$ cd 49b6fbc4bafdef029183\n$ make run</span></code></pre>\n    </div>\n<p>Now, if you are on a mac, you need to figure out the IP and port where\nnotebook is running with:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\">\n      <pre class=\" cm-s-solarized\"><code><span class=\"cm-def\">$ docker</span><span class=\"cm-attribute\">-machine</span><span> ip default</span><span>\n</span><span class=\"cm-def\">$ docker</span><span> </span><span class=\"cm-builtin\">ps</span></code></pre>\n    </div>\n<h2>Explanation</h2>\n<p>At first, both of my Jupyter gists are based on my <a href=\"https://github.com/datakurre/nix-build-pack-docker\">recipe for building\nDocker containers with\nNix</a>.</p>\n<p>It builds a Docker image with Nix installation to build your Nix\nexpressions, creates a nix store data container to store and share built\nNix expressions between builds, and creates a Docker ready tarball from\na built nix closure.</p>\n<p>Then a few picks from the expressions:</p>\n<div class=\"gatsby-highlight\" data-language=\"nix\">\n      <pre class=\" cm-s-solarized\"><code><span>with import &lt;nixpkgs&gt; {};\nlet dependencies = rec {\n  # ...\n  jupyter = python35Packages.notebook.override {\n    postInstall = with python35Packages; ''\n      mkdir -p $out/bin\n      ln -s ${jupyter_core}/bin/jupyter $out/bin\n      wrapProgram $out/bin/jupyter \\\n        --prefix PYTHONPATH : \"${notebook}/lib/python3.5/site-packages:$PYTHONPATH\" \\\n        --prefix PATH : \"${notebook}/bin:$PATH\"\n    '';\n  };\n# ...\n}</span></code></pre>\n    </div>\n<p>To be able to run Jupyter notebook, I want to use the normal <code>jupyter</code>\ncommand, but a problem is that the base command is defined in a python\npackage <a href=\"https://pypi.python.org/pypi/jupyter_core\">jupyter_core</a>,\nwhich does not include\n<a href=\"https://pypi.python.org/pypi/notebook\">notebook</a>-package, which\nincludes the actual Jupyter notebook program and its <code>jyputer notebook</code>\nsubcommand. The Nix solution is to install\n<a href=\"https://pypi.python.org/pypi/notebook\">notebook</a> package, but enhance\nits install with a custom postinstall, whick links the command from\n<a href=\"https://pypi.python.org/pypi/jupyter_core\">jupyter_core</a> and wraps the\ncommand to be aware of <a href=\"https://pypi.python.org/pypi/notebook\">notebook</a>\nand itse dependencies.</p>\n<div class=\"gatsby-highlight\" data-language=\"nix\">\n      <pre class=\" cm-s-solarized\"><code><span>with import &lt;nixpkgs&gt; {};\nlet dependencies = rec {\n  builder = builtins.toFile \"builder.sh\" ''\n    source $stdenv/setup\n    mkdir -p $out\n    cat &gt; $out/kernel.json &lt;&lt; EOF\n    $json\n    EOF\n  '';\n  # ...\n  python34 = pkgs.python34.buildEnv.override {\n    extraLibs = with python34Packages; [\n      # Kernel\n      ipykernel\n      ipywidgets\n      # Custom packages\n      lightning\n      # ...\n    ];\n  };\n  python34_kernel = stdenv.mkDerivation rec {\n    name = \"python34\";\n    buildInputs = [ python34 ];\n    json = builtins.toJSON {\n      argv = [ \"${python34}/bin/python3.4\"\n               \"-m\" \"ipykernel\" \"-f\" \"{connection_file}\" ];\n      display_name = \"Python 3.4\";\n      language = \"python\";\n      env = { PYTHONPATH = \"\"; };\n    };\n    inherit builder;\n  };\n# ...\n}</span></code></pre>\n    </div>\n<p>Next I want to be able to define and configure as many Jupyter kernels\nas I need in my notebook. This pattern first defines the kernel\nenvironment. Above that is Python 3.4 with the mandatory iPython\npackages and then any amount of Python packages I want to provide for\nthe notebook.</p>\n<p>The second part of the pattern just defines an iPython kernel\nconfiguration (usually created using <code>jupyter kernelspec</code> in mutable\nJupyter installations) so that the kernel uses our previously defined\nPython 3.4 environment. The builder for actually creating the\nconfiguration file is defined an upper level of the expression so that\nit can easily be re-used with <code>inherit builder;</code>.</p>\n<p>With this approach, is possible to have as many different and\ndifferently configured kernels as you want. It’s possible to have both\nPython 3.4 and 3.5 or many different configurations for the same\nversion. For example, when there’s a major upgrade in some package,\nit’s possible to have one kernel with the old version and another with\nthe new version.</p>\n<p>The example gists also include similarly configurable kernel\nconfiguration for <a href=\"https://www.r-project.org/\">R</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"nix\">\n      <pre class=\" cm-s-solarized\"><code><span>with import &lt;nixpkgs&gt; {};\nlet dependencies = rec {\n  # ...\n  jupyter_config_dir = stdenv.mkDerivation {\n    name = \"jupyter\";\n    buildInputs = [\n      python34_kernel\n      R_kernel\n    ];\n    builder = writeText \"builder.sh\" ''\n      source $stdenv/setup\n      mkdir -p $out/etc/jupyter/kernels $out/etc/jupyter/migrated\n      ln -s ${python34_kernel} $out/etc/jupyter/kernels/${python34_kernel.name}\n      ln -s ${R_kernel} $out/etc/jupyter/kernels/${R_kernel.name}\n      cat &gt; $out/etc/jupyter/jupyter_notebook_config.py &lt;&lt; EOF\n      import os\n      c.KernelSpecManager.whitelist = {\n        '${python34_kernel.name}',\n        '${R_kernel.name}'\n      }\n      c.NotebookApp.ip = os.environ.get('JUPYTER_NOTEBOOK_IP', 'localhost')\n      EOF\n    '';\n  };\n  # ...\n};</span></code></pre>\n    </div>\n<p>The next most important part is the expression to compose all the\ndefined kernels into a compelete and immutable Jupyter configuration\ndirectory. Whitelisting kernels in configuration is required to hide the\nPython environment running the Jupyter notebook (because it only has the\nnotebook dependencies and is missing all the interesting libraries). The\nline with <code>c.NotebookApp.ip</code> allows Docker to configure notebook to\nallow connections outside the container.</p>\n<div class=\"gatsby-highlight\" data-language=\"nix\">\n      <pre class=\" cm-s-solarized\"><code><span>with import &lt;nixpkgs&gt; {};\nlet dependencies = rec {\n  # ...\n};\nin with dependencies;\nstdenv.mkDerivation rec {\n  name = \"jupyter\";\n  env = buildEnv { name = name; paths = buildInputs; };\n  builder = builtins.toFile \"builder.sh\" ''\n    source $stdenv/setup; ln -s $env $out\n  '';\n  buildInputs = [\n    jupyter\n    jupyter_config_dir\n  ] ++ stdenv.lib.optionals stdenv.isLinux [ bash fontconfig tini ];\n  shellHook = ''\n    mkdir -p $PWD/.jupyter\n    export JUPYTER_CONFIG_DIR=${jupyter_config_dir}/etc/jupyter\n    export JUPYTER_PATH=${jupyter_config_dir}/etc/jupyter\n    export JUPYTER_DATA_DIR=$PWD/.jupyter\n    export JUPYTER_RUNTIME_DIR=$PWD/.jupyter\n  '';\n}</span></code></pre>\n    </div>\n<p>Finally, we define an buildable environment installation, which mainly\nincludes Jupyter (command) and its configuration. On Linux a few extra\ndependencies are added to make Jupyter run in a Docker container. For\n<code>nix-shell</code> command the expression configures Jupyter to look\nconfiguration from the Nix built configuration directory and store\nvolatile runtime files under the current working directory.</p>\n<p>Environment variables are also the way to configure Jupyter to run\nproperly in a Docker container. My Dockerfile configures Jupyter to look\nconfiguration from the directory created by my <a href=\"https://github.com/datakurre/nix-build-pack-docker\">recipe for building\nDocker containers with\nNix</a>, and store\nvolatile runtime files under the host directory mounted as <code>/mnt</code>. In my\nexample Makefile that’s configured to be the current working directory,\nwhich is also used shown as the notebook home directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"Dockerfile\">\n      <pre class=\" cm-s-solarized\"><code><span>FROM scratch\nADD default.nix.tar.gz /\nENV FONTCONFIG_FILE=\"/etc/fonts/fonts.conf\" \\\n    JUPYTER_NOTEBOOK_IP=\"*\" \\\n    JUPYTER_CONFIG_DIR=\"/etc/jupyter\" \\\n    JUPYTER_PATH=\"/etc/jupyter\" \\\n    JUPYTER_DATA_DIR=\"/mnt/.jupyter\" \\\n    JUPYTER_RUNTIME_DIR=\"/mnt/.jupyter\"\nEXPOSE 8888\nENTRYPOINT [\"/bin/tini\", \"--\", \"/bin/jupyter\"]</span></code></pre>\n    </div>\n<p><strong>Note:</strong> Running Jupyter notebook in Docker container may require\n<a href=\"https://github.com/krallin/tini\">tini</a> (or\n<a href=\"https://pypi.python.org/pypi/supervisor\">supervisor</a>) to allow Jupyter\nspawn all the kernel processes it needs within the container.</p>","frontmatter":{"title":"Creating Jupyter Docker-containers with Nix","tags":["Jupyter","Nix","R"],"date":"November 13, 2015","published":"2015-11-13 06:00:00"}}},"pageContext":{"slug":"/2015/11/creating-jupyter-docker-containers-with.html/","previous":{"fields":{"slug":"/2015/10/nix-for-python-developers.html/"},"frontmatter":{"title":"Nix for Python developers"}},"next":{"fields":{"slug":"/2015/11/nix-in-docker-best-of-both-worlds.html/"},"frontmatter":{"title":"Nix in Docker – Best of Both Worlds"}}}},"staticQueryHashes":["63159454"],"slicesMap":{}}
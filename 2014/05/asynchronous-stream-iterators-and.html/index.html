<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}div.mermaid svg{height:auto !important;}</style><meta name="generator" content="Gatsby 5.2.0"/><meta name="author" content="Asko Soukka" data-gatsby-head="true"/><meta name="description" property="og:description" content="This post may contain traces of legacy Zope2 and Python 2.x. Some may think that Plone is bad in concurrency,
because it’s not common to deployt it with
WSGI…" data-gatsby-head="true"/><meta name="title" property="og:title" content="Asynchronous stream iterators and experimental promises for Plone" data-gatsby-head="true"/><meta name="type" property="og:type" content="website" data-gatsby-head="true"/><meta name="twitter:card" content="summary" data-gatsby-head="true"/><meta name="twitter:creator" content="Asko Soukka" data-gatsby-head="true"/><meta name="twitter:title" content="Asynchronous stream iterators and experimental promises for Plone" data-gatsby-head="true"/><meta name="twitter:description" content="This post may contain traces of legacy Zope2 and Python 2.x. Some may think that Plone is bad in concurrency,
because it’s not common to deployt it with
WSGI…" data-gatsby-head="true"/><meta name="image" property="og:image" content="https://datakurre.pandala.org/cover-2014-05-asynchronous-stream-iterators-and.html.png" data-gatsby-head="true"/><meta name="twitter:image" content="https://datakurre.pandala.org/cover-2014-05-asynchronous-stream-iterators-and.html.png" data-gatsby-head="true"/><meta name="theme-color" content="#663399"/><style data-href="/styles.5caeda19fca28245274c.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}.solarized.base03{color:#002b36}.solarized.base02{color:#073642}.solarized.base01{color:#586e75}.solarized.base00{color:#657b83}.solarized.base0{color:#839496}.solarized.base1{color:#93a1a1}.solarized.base2{color:#eee8d5}.solarized.base3{color:#fdf6e3}.solarized.solar-yellow{color:#b58900}.solarized.solar-orange{color:#cb4b16}.solarized.solar-red{color:#dc322f}.solarized.solar-magenta{color:#d33682}.solarized.solar-violet{color:#6c71c4}.solarized.solar-blue{color:#268bd2}.solarized.solar-cyan{color:#2aa198}.solarized.solar-green{color:#859900}.cm-s-solarized{color-profile:sRGB;rendering-intent:auto;line-height:1.45em}.cm-s-solarized.cm-s-dark{background-color:#002b36;color:#839496;text-shadow:#002b36 0 1px}.cm-s-solarized.cm-s-light{background-color:#fdf6e3;color:#657b83;text-shadow:#eee8d5 0 1px}.cm-s-solarized .CodeMirror-widget{text-shadow:none}.cm-s-solarized .cm-header{color:#586e75}.cm-s-solarized .cm-quote{color:#93a1a1}.cm-s-solarized .cm-keyword{color:#cb4b16}.cm-s-solarized .cm-atom,.cm-s-solarized .cm-number{color:#d33682}.cm-s-solarized .cm-def{color:#2aa198}.cm-s-solarized .cm-variable{color:#839496}.cm-s-solarized .cm-variable-2{color:#b58900}.cm-s-solarized .cm-type,.cm-s-solarized .cm-variable-3{color:#6c71c4}.cm-s-solarized .cm-property{color:#2aa198}.cm-s-solarized .cm-operator{color:#6c71c4}.cm-s-solarized .cm-comment{color:#586e75;font-style:italic}.cm-s-solarized .cm-string{color:#859900}.cm-s-solarized .cm-string-2{color:#b58900}.cm-s-solarized .cm-meta{color:#859900}.cm-s-solarized .cm-qualifier{color:#b58900}.cm-s-solarized .cm-builtin{color:#d33682}.cm-s-solarized .cm-bracket{color:#cb4b16}.cm-s-solarized .CodeMirror-matchingbracket{color:#859900}.cm-s-solarized .CodeMirror-nonmatchingbracket{color:#dc322f}.cm-s-solarized .cm-tag{color:#93a1a1}.cm-s-solarized .cm-attribute{color:#2aa198}.cm-s-solarized .cm-hr{border-top:1px solid #586e75;color:transparent;display:block}.cm-s-solarized .cm-link{color:#93a1a1;cursor:pointer}.cm-s-solarized .cm-special{color:#6c71c4}.cm-s-solarized .cm-em{color:#999;text-decoration:underline;text-decoration-style:dotted}.cm-s-solarized .cm-error,.cm-s-solarized .cm-invalidchar{border-bottom:1px dotted #dc322f;color:#586e75}.cm-s-solarized.cm-s-dark div.CodeMirror-selected{background:#073642}.cm-s-solarized.cm-s-dark.CodeMirror ::selection{background:rgba(7,54,66,.99)}.cm-s-dark .CodeMirror-line>span::-moz-selection,.cm-s-dark .CodeMirror-line>span>span::-moz-selection,.cm-s-solarized.cm-s-dark .CodeMirror-line::-moz-selection{background:rgba(7,54,66,.99)}.cm-s-solarized.cm-s-light div.CodeMirror-selected{background:#eee8d5}.cm-s-light .CodeMirror-line>span::selection,.cm-s-light .CodeMirror-line>span>span::selection,.cm-s-solarized.cm-s-light .CodeMirror-line::selection{background:#eee8d5}.cm-s-ligh .CodeMirror-line>span::-moz-selection,.cm-s-ligh .CodeMirror-line>span>span::-moz-selection,.cm-s-solarized.cm-s-light .CodeMirror-line::-moz-selection{background:#eee8d5}.cm-s-solarized.CodeMirror{box-shadow:inset 7px 0 12px -6px #000}.cm-s-solarized .CodeMirror-gutters{border-right:0}.cm-s-solarized.cm-s-dark .CodeMirror-gutters{background-color:#073642}.cm-s-solarized.cm-s-dark .CodeMirror-linenumber{color:#586e75;text-shadow:#021014 0 -1px}.cm-s-solarized.cm-s-light .CodeMirror-gutters{background-color:#eee8d5}.cm-s-solarized.cm-s-light .CodeMirror-linenumber{color:#839496}.cm-s-solarized .CodeMirror-linenumber{padding:0 5px}.cm-s-solarized .CodeMirror-guttermarker-subtle{color:#586e75}.cm-s-solarized.cm-s-dark .CodeMirror-guttermarker{color:#ddd}.cm-s-solarized.cm-s-light .CodeMirror-guttermarker{color:#cb4b16}.cm-s-solarized .CodeMirror-gutter .CodeMirror-gutter-text{color:#586e75}.cm-s-solarized .CodeMirror-cursor{border-left:1px solid #819090}.cm-s-solarized.cm-s-light.cm-fat-cursor .CodeMirror-cursor{background:#7e7}.cm-s-solarized.cm-s-light .cm-animate-fat-cursor{background-color:#7e7}.cm-s-solarized.cm-s-dark.cm-fat-cursor .CodeMirror-cursor{background:#586e75}.cm-s-solarized.cm-s-dark .cm-animate-fat-cursor{background-color:#586e75}.cm-s-solarized.cm-s-dark .CodeMirror-activeline-background{background:hsla(0,0%,100%,.06)}.cm-s-solarized.cm-s-light .CodeMirror-activeline-background{background:rgba(0,0,0,.06)}ol,ul{margin-left:1em}.gatsby-highlight{background:#fdfaf6;border-bottom:1px solid #eee;border-top:1px solid #eee;margin-bottom:1.75rem;overflow-x:auto;padding:1ex 1em}.gatsby-highlight pre{margin-bottom:0}</style><title data-gatsby-head="true">Asynchronous stream iterators and experimental promises for Plone | Asko Soukka</title><link rel="canonical" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/" data-gatsby-head="true"/><link rel="alternate" type="application/rss+xml" title="datakurre" href="/rss.xml"/><link rel="alternate" type="application/rss+xml" title="datakurre on &quot;plone&quot;" href="/feeds/posts/default/-/plone"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=b12376b9b88c2b74e77175e369294c9a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=b12376b9b88c2b74e77175e369294c9a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=b12376b9b88c2b74e77175e369294c9a"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">Asko Soukka</a></h3></header><main class="h-entry"><h1 style="margin-top:1.75rem;margin-bottom:0">Asynchronous stream iterators and experimental promises for Plone</h1><span class="p-name" style="display:none">Asynchronous stream iterators and experimental promises for Plone</span><img class="u-photo" src="https://datakurre.pandala.org/cover-2014-05-asynchronous-stream-iterators-and.html.png" alt="" style="display:none"/><a class="p-author h-card" href="https://pandala.org/#datakurre" style="display:none"><img class="u-photo" src="https://datakurre.pandala.org/icon.jpg" alt=""/>Asko Soukka</a><div class="p-summary" style="display:none"><div>This post may contain traces of legacy Zope2 and Python 2.x. Some may think that Plone is bad in concurrency,
because it’s not common to deployt it with
WSGI…</div></div><a class="p-category" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/" style="display:none">Async</a><a class="p-category" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/" style="display:none">Asyncore</a><a class="p-category" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/" style="display:none">Plone</a><a class="p-category" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/" style="display:none">Python</a><a class="u-syndication" href="https://fed.brid.gy/" style="display:none">https://fed.brid.gy/</a><a class="u-syndication" href="https://fediverse.pandala.org/" style="display:none">https://fediverse.pandala.org/</a><a class="u-url u-uid" style="font-size:0.83255rem;line-height:1.75rem;display:block;color:black;box-shadow:none;margin-bottom:1.75rem" href="https://datakurre.pandala.org/2014/05/asynchronous-stream-iterators-and.html/"><time class="dt-published" datetime="2014-05-04 06:00:00">May 04, 2014</time></a><div class="e-content"><div><p><em>This post may contain traces of legacy Zope2 and Python 2.x.</em></p>
<p>Some may think that <a href="https://plone.org/">Plone</a> is bad in concurrency,
because it’s not common to deployt it with
<a href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a>, but
run it on top of a barely known last millennium asynchronous HTTP server
called <a href="http://www.nightmare.com/medusa/">Medusa</a>.</p>
<p>See, The out-of-the-box installation of Plone launches with only a
single asynchronous HTTP server with just two fixed long-running worker
threads. And it’s way too easy to write custom code to keep those
worker threads busy (for example, by with writing blocking calls to
external services), effectively resulting denial of service for rest of
the incoming requests</p>
<p>Well, as far as I know, the real bottleneck is not Medusa, but the way
how <a href="http://en.wikipedia.org/wiki/Zope_Object_Database">ZODB</a> database
connections work. It seems that to optimize the database connection
related caches, ZODB is best used with fixed amount of concurrent worker
threads, and one dedicated database connection per thread. Finally,
<a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> in
ZODB limits each thread can serve only one request at time.</p>
<p>In practice, of course, Plone-sites use ZEO-clustering (and replication)
to overcome the limitations described above.</p>
<p><strong>Back to the topic (with a disclaimer).</strong> The methods described in this
blog post have not been battle tested yet and they may turn out to be
bad ideas. Still, it’s been fun to figure out how our old asynchronous
friend, Medusa, could be used to serve more concurrent request in
certain special cases.</p>
<h2>ZPublisher stream iterators</h2>
<p>If you have been working with Plone long enough, you must have heard the
rumor that blobs, which basically means files and images, are served
from the filesystem in some special non-blocking way.</p>
<p>So, when someone downloads a file from Plone, the current worker thread
only initiates the download and can then continue to serve the next
request. The actually file is left to be served asynchronously by the
main thread.</p>
<p>This is possible because of a ZPublisher feature called <em>stream
iterators</em> (search IStreamIterator interface and its implementations in
Zope2 and plone.app.blobs). Stream iterators are basically a way to
postpone I/O-bound operations into the main thread’s asyncore loop
through a special Medusa-level producer object.</p>
<p>And because stream iterators are consumed only within the main thread,
they come with some very strict limitations:</p>
<ul>
<li>they are executed only after a completed transaction so they cannot
interact with the transaction anymore</li>
<li>they must not read from the ZODB (because their origin connection is
either closed or in use of their origin worker thread)</li>
<li>they must not fail unexpectedly, because you don’t want to crash
the main thread</li>
<li>they must not block the main thread, for obvious reasons.</li>
</ul>
<p>Because of these limitations, the stream iterators, as such, are usable
only for the purpose they have been made for: streaming files or similar
immediately available buffers.</p>
<h2>Asynchronous stream iterators</h2>
<p>What if you could use ZPublisher’s stream iterator support also for
CPU-bound post-processing tasks? Or for post-processing tasks requiring
calls to external web services or command-line utilities?</p>
<p>If you have a local Plone instance running somewhere, you can add the
following proof-of-concept code and its <code>slow_ok</code>-method into a new
<a href="http://docs.zope.org/zope2/zope2book/ScriptingZope.html#using-external-methods">External
Method</a>
(also available as a
<a href="https://gist.github.com/datakurre/b273a6bf9285ee779542">gist</a>):</p>
<div class="gatsby-highlight" data-language="python">
      <pre class=" cm-s-solarized"><code><span class="cm-keyword">import</span><span> </span><span class="cm-variable">StringIO</span><span>
</span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">threading</span><span>

</span><span class="cm-keyword">from</span><span> </span><span class="cm-variable">zope</span><span>.</span><span class="cm-property">interface</span><span> </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">implements</span><span>
</span><span class="cm-keyword">from</span><span> </span><span class="cm-variable">ZPublisher</span><span>.</span><span class="cm-property">Iterators</span><span> </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">IStreamIterator</span><span>
</span><span class="cm-keyword">from</span><span> </span><span class="cm-variable">ZServer</span><span>.</span><span class="cm-property">PubCore</span><span>.</span><span class="cm-property">ZEvent</span><span> </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">Wakeup</span><span>

</span><span class="cm-keyword">from</span><span> </span><span class="cm-variable">zope</span><span>.</span><span class="cm-property">globalrequest</span><span> </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">getRequest</span><span>


</span><span class="cm-keyword">class</span><span> </span><span class="cm-def">zhttp_channel_async_wrapper</span><span>(</span><span class="cm-builtin">object</span><span>):</span><span>
</span><span>    </span><span class="cm-string">"""Medusa channel wrapper to defer producers until released"""</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">__init__</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">channel</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the current Zope worker thread)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_channel</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">channel</span><span>

</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_mutex</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">threading</span><span>.</span><span class="cm-property">Lock</span><span>()</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_deferred</span><span> </span><span class="cm-operator">=</span><span> []</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_released</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-keyword">False</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_content_length</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-number">0</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">_push</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span class="cm-operator">=</span><span class="cm-number">1</span><span>):</span><span>
</span><span>        </span><span class="cm-keyword">if</span><span> (</span><span class="cm-builtin">isinstance</span><span>(</span><span class="cm-variable">producer</span><span>, </span><span class="cm-builtin">str</span><span>)</span><span>
</span><span>                </span><span class="cm-keyword">and</span><span> </span><span class="cm-variable">producer</span><span>.</span><span class="cm-property">startswith</span><span>(</span><span class="cm-string">'HTTP/1.1 200 OK'</span><span>)):</span><span>
</span><span>            </span><span class="cm-comment"># Fix Content-Length to match the real content length</span><span>
</span><span>            </span><span class="cm-comment"># (an alternative would be to use chunked encoding)</span><span>
</span><span>            </span><span class="cm-variable">producer</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">producer</span><span>.</span><span class="cm-property">replace</span><span>(</span><span>
</span><span>                </span><span class="cm-string">'Content-Length: 0\r\n'</span><span>,</span><span>
</span><span>                </span><span class="cm-string">'Content-Length: {0:s}\r\n'</span><span>.</span><span class="cm-property">format</span><span>(</span><span class="cm-builtin">str</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_content_length</span><span>))</span><span>
</span><span>            )</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_channel</span><span>.</span><span class="cm-property">push</span><span>(</span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span>)</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">push</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span class="cm-operator">=</span><span class="cm-number">1</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the current Zope worker thread)</span><span>
</span><span>        </span><span class="cm-keyword">with</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_mutex</span><span>:</span><span>
</span><span>            </span><span class="cm-keyword">if</span><span> </span><span class="cm-keyword">not</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_released</span><span>:</span><span>
</span><span>                </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_deferred</span><span>.</span><span class="cm-property">append</span><span>((</span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span>))</span><span>
</span><span>            </span><span class="cm-keyword">else</span><span>:</span><span>
</span><span>                </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_push</span><span>(</span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span>)</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">release</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">content_length</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the exclusive async thread)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_content_length</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">content_length</span><span>
</span><span>        </span><span class="cm-keyword">with</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_mutex</span><span>:</span><span>
</span><span>            </span><span class="cm-keyword">for</span><span> </span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span> </span><span class="cm-keyword">in</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_deferred</span><span>:</span><span>
</span><span>                </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_push</span><span>(</span><span class="cm-variable">producer</span><span>, </span><span class="cm-variable">send</span><span>)</span><span>
</span><span>            </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_released</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-keyword">True</span><span>
</span><span>        </span><span class="cm-variable">Wakeup</span><span>()  </span><span class="cm-comment"># wake up the asyncore loop to read our results</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">__getattr__</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">key</span><span>):</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-builtin">getattr</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_channel</span><span>, </span><span class="cm-variable">key</span><span>)</span><span>


</span><span class="cm-keyword">class</span><span> </span><span class="cm-def">AsyncWorkerStreamIterator</span><span>(</span><span class="cm-variable">StringIO</span><span>.</span><span class="cm-property">StringIO</span><span>):</span><span>
</span><span>    </span><span class="cm-string">"""Stream iterator to publish the results of the given func"""</span><span>

</span><span>    </span><span class="cm-variable">implements</span><span>(</span><span class="cm-variable">IStreamIterator</span><span>)</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">__init__</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">func</span><span>, </span><span class="cm-variable">response</span><span>, </span><span class="cm-variable">streamsize</span><span class="cm-operator">=</span><span class="cm-number">1</span><span> </span><span class="cm-operator">&lt;&lt;</span><span> </span><span class="cm-number">16</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the current Zope worker thread)</span><span>

</span><span>        </span><span class="cm-comment"># Init buffer</span><span>
</span><span>        </span><span class="cm-variable">StringIO</span><span>.</span><span class="cm-property">StringIO</span><span>.</span><span class="cm-property">__init__</span><span>(</span><span class="cm-variable-2">self</span><span>)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_streamsize</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">streamsize</span><span>

</span><span>        </span><span class="cm-comment"># Wrap the Medusa channel to wait for the func results</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_channel</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">response</span><span>.</span><span class="cm-property">stdout</span><span>.</span><span class="cm-property">_channel</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_wrapped_channel</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">zhttp_channel_async_wrapper</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_channel</span><span>)</span><span>
</span><span>        </span><span class="cm-variable">response</span><span>.</span><span class="cm-property">stdout</span><span>.</span><span class="cm-property">_channel</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_wrapped_channel</span><span>

</span><span>        </span><span class="cm-comment"># Set content-length as required by ZPublisher</span><span>
</span><span>        </span><span class="cm-variable">response</span><span>.</span><span class="cm-property">setHeader</span><span>(</span><span class="cm-string">'content-length'</span><span>, </span><span class="cm-string">'0'</span><span>)</span><span>

</span><span>        </span><span class="cm-comment"># Fire the given func in a separate thread</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">thread</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">threading</span><span>.</span><span class="cm-property">Thread</span><span>(</span><span class="cm-variable">target</span><span class="cm-operator">=</span><span class="cm-variable">func</span><span>, </span><span class="cm-variable">args</span><span class="cm-operator">=</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">callback</span><span>,))</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">thread</span><span>.</span><span class="cm-property">start</span><span>()</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">callback</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">data</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the exclusive async thread)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">write</span><span>(</span><span class="cm-variable">data</span><span>)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">seek</span><span>(</span><span class="cm-number">0</span><span>)</span><span>
</span><span>        </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_wrapped_channel</span><span>.</span><span class="cm-property">release</span><span>(</span><span class="cm-builtin">len</span><span>(</span><span class="cm-variable">data</span><span>))</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-builtin">next</span><span>(</span><span class="cm-variable-2">self</span><span>):</span><span>
</span><span>        </span><span class="cm-comment"># (executed within the main thread)</span><span>
</span><span>        </span><span class="cm-keyword">if</span><span> </span><span class="cm-keyword">not</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">closed</span><span>:</span><span>
</span><span>            </span><span class="cm-variable">data</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">read</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_streamsize</span><span>)</span><span>
</span><span>            </span><span class="cm-keyword">if</span><span> </span><span class="cm-keyword">not</span><span> </span><span class="cm-variable">data</span><span>:</span><span>
</span><span>                </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">close</span><span>()</span><span>
</span><span>            </span><span class="cm-keyword">else</span><span>:</span><span>
</span><span>                </span><span class="cm-keyword">return</span><span> </span><span class="cm-variable">data</span><span>
</span><span>        </span><span class="cm-keyword">raise</span><span> </span><span class="cm-variable">StopIteration</span><span>

</span><span>    </span><span class="cm-keyword">def</span><span> </span><span class="cm-def">__len__</span><span>(</span><span class="cm-variable-2">self</span><span>):</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-builtin">len</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">getvalue</span><span>())</span><span>


</span><span class="cm-keyword">def</span><span> </span><span class="cm-def">slow_ok_worker</span><span>(</span><span class="cm-variable">callback</span><span>):</span><span>
</span><span>    </span><span class="cm-comment"># (executed within the exclusive async thread)</span><span>
</span><span>    </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">time</span><span>
</span><span>    </span><span class="cm-variable">time</span><span>.</span><span class="cm-property">sleep</span><span>(</span><span class="cm-number">1</span><span>)</span><span>
</span><span>    </span><span class="cm-variable">callback</span><span>(</span><span class="cm-string">'OK'</span><span>)</span><span>


</span><span class="cm-keyword">def</span><span> </span><span class="cm-def">slow_ok</span><span>():</span><span>
</span><span>    </span><span class="cm-string">"""The publishable example method"""</span><span>
</span><span>    </span><span class="cm-comment"># (executed within the current Zope worker thread)</span><span>
</span><span>    </span><span class="cm-variable">request</span><span> </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">getRequest</span><span>()</span><span>
</span><span>    </span><span class="cm-keyword">return</span><span> </span><span class="cm-variable">AsyncWorkerStreamIterator</span><span>(</span><span class="cm-variable">slow_ok_worker</span><span>, </span><span class="cm-variable">request</span><span>.</span><span class="cm-property">response</span><span>)</span></code></pre>
    </div>
<p>The above code example simulates a trivial post-processing with
<code>time.sleep</code>, but it should apply for anything from building a PDF from
the extracted data to calling an external web service before returning
the final response.</p>
<p>An out-of-the-box Plone instance can handle only two (2) concurrent
calls to a method, which would take one (1) second to complete.</p>
<p>In the above code, however, the post-processing could be delegated to a
completely new thread, freeing the Zope worker thread to continue to
handle the next request. Because of that, we can get much much better
concurrency:</p>
<div class="gatsby-highlight" data-language="shell">
      <pre class=" cm-s-solarized"><code><span class="cm-def">$ ab</span><span> </span><span class="cm-attribute">-c</span><span> </span><span class="cm-number">100</span><span> </span><span class="cm-attribute">-n</span><span> </span><span class="cm-number">100</span><span> http://localhost:8080/Plone/slow_ok</span><span>
</span><span>This is ApacheBench, Version </span><span class="cm-number">2</span><span>.3 &lt;</span><span class="cm-def">$Revision</span><span>: </span><span class="cm-number">655654</span><span> </span><span class="cm-def">$&gt;</span><span>
</span><span>Copyright </span><span class="cm-number">1996</span><span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><span>
</span><span>Licensed to The Apache Software Foundation, http://www.apache.org/</span><span>

</span><span>Benchmarking localhost (be patient).....done</span><span>

</span><span>Server Software:        Zope/(2.13.22,</span><span>
</span><span>Server Hostname:        localhost</span><span>
</span><span>Server Port:            </span><span class="cm-number">8080</span><span>

</span><span>Document Path:          /Plone/slow_ok</span><span>
</span><span>Document Length:        </span><span class="cm-number">2</span><span> bytes</span><span>

</span><span>Concurrency Level:      </span><span class="cm-number">100</span><span>
</span><span>Time taken </span><span class="cm-keyword">for</span><span> tests:   </span><span class="cm-number">1</span><span>.364 seconds</span><span>
</span><span>Complete requests:      </span><span class="cm-number">100</span><span>
</span><span>Failed requests:        </span><span class="cm-number">0</span><span>
</span><span>Write errors:           </span><span class="cm-number">0</span><span>
</span><span>Total transferred:      </span><span class="cm-number">15400</span><span> bytes</span><span>
</span><span>HTML transferred:       </span><span class="cm-number">200</span><span> bytes</span><span>
</span><span>Requests per second:    </span><span class="cm-number">73</span><span>.32 [</span><span class="cm-comment">#/sec] (mean)</span><span>
</span><span>Time per request:       </span><span class="cm-number">1363</span><span>.864 [ms] (mean)</span><span>
</span><span>Time per request:       </span><span class="cm-number">13</span><span>.639 [ms] (mean, across all concurrent requests)</span><span>
</span><span>Transfer rate:          </span><span class="cm-number">11</span><span>.03 [Kbytes/sec] received</span><span>

</span><span>Connection Times (ms)</span><span>
</span><span>               min  mean[</span><span class="cm-operator">+</span><span>/-sd] median   max</span><span>
</span><span>Connect:        </span><span class="cm-number">1</span><span>    </span><span class="cm-number">2</span><span>   </span><span class="cm-number">0</span><span>.6      </span><span class="cm-number">2</span><span>       </span><span class="cm-number">3</span><span>
</span><span>Processing:  </span><span class="cm-number">1012</span><span> </span><span class="cm-number">1196</span><span>  </span><span class="cm-number">99</span><span>.2   </span><span class="cm-number">1202</span><span>    </span><span class="cm-number">1359</span><span>
</span><span>Waiting:     </span><span class="cm-number">1011</span><span> </span><span class="cm-number">1196</span><span>  </span><span class="cm-number">99</span><span>.3   </span><span class="cm-number">1202</span><span>    </span><span class="cm-number">1359</span><span>
</span><span>Total:       </span><span class="cm-number">1015</span><span> </span><span class="cm-number">1199</span><span>  </span><span class="cm-number">98</span><span>.6   </span><span class="cm-number">1204</span><span>    </span><span class="cm-number">1361</span><span>

</span><span>Percentage of the requests served within a certain time (ms)</span><span>
</span><span>  </span><span class="cm-number">50</span><span>%   </span><span class="cm-number">1204</span><span>
</span><span>  </span><span class="cm-number">66</span><span>%   </span><span class="cm-number">1256</span><span>
</span><span>  </span><span class="cm-number">75</span><span>%   </span><span class="cm-number">1283</span><span>
</span><span>  </span><span class="cm-number">80</span><span>%   </span><span class="cm-number">1301</span><span>
</span><span>  </span><span class="cm-number">90</span><span>%   </span><span class="cm-number">1331</span><span>
</span><span>  </span><span class="cm-number">95</span><span>%   </span><span class="cm-number">1350</span><span>
</span><span>  </span><span class="cm-number">98</span><span>%   </span><span class="cm-number">1357</span><span>
</span><span>  </span><span class="cm-number">99</span><span>%   </span><span class="cm-number">1361</span><span>
</span><span>  </span><span class="cm-number">100</span><span>%   </span><span class="cm-number">1361</span><span> (longest request)</span></code></pre>
    </div>
<p>Of course, most of the stream iterator limits still apply: Asynchronous
stream iterator must not access the database, which limits the possible
use cases a lot. For the same reasons, also
<a href="https://pypi.python.org/pypi/plone.transformchain">plone.transformchain</a>
is effectively skipped (no
<a href="https://pypi.python.org/pypi/plone.app.theming">Diazo</a> or
<a href="https://pypi.python.org/pypi/plone.app.blocks">Blocks</a>), which limits
this to be usable only for non-HTML responses.</p>
<h2>experimental.promises</h2>
<p>To go experimenting even further, what if you could do similar
non-blocking asynchronous processing in the middle of a request? For
example, to free the current Zope working thread while fetching a
missing or outdated RSS feed in a separate thread and only then continue
to render the final response.</p>
<p>An interesting side effect of using streaming iterators is that they
allow you to inject code into the main thread’s asynchronous loop. And
when you are there, it’s even possible to queue completely new request
for ZPublisher to handle.</p>
<p>So, how would the following approach sound like:</p>
<ul>
<li>
<p>let add-on code to annotate requests with
<a href="http://en.wikipedia.org/wiki/Futures_and_promises">promises</a> for
fetching the required data (each promise would be a standalone
function, which could be executed under the asynchronous stream
iterator rules, and when called, would resolve into a value,
effectively the <em>future</em> of the promise), for example:</p>
<div class="gatsby-highlight" data-language="python">
      <pre class=" cm-s-solarized"><code><span class="cm-meta">@property</span><span>
</span><span class="cm-keyword">def</span><span> </span><span class="cm-def">content</span><span>(</span><span class="cm-variable-2">self</span><span>):</span><span>
</span><span>    </span><span class="cm-keyword">if</span><span> </span><span class="cm-string">'my_unique_key'</span><span> </span><span class="cm-keyword">in</span><span> </span><span class="cm-variable">IFutures</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>):</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-variable">IFutures</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>)[</span><span class="cm-string">'my_unique_key'</span><span>]</span><span>
</span><span>    </span><span class="cm-keyword">else</span><span>:</span><span>
</span><span>        </span><span class="cm-variable">IPromises</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>)[</span><span class="cm-string">'my_unique_key'</span><span>] </span><span class="cm-operator">=</span><span> </span><span class="cm-variable">my_promise_func</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-string">u''</span></code></pre>
    </div>
</li>
<li>
<p>when promises are found, the response is turned into an asynchronous
stream iterator, which would then execute all the promises in
parallel threads and collects the resolved values, futures:</p>
<div class="gatsby-highlight" data-language="python">
      <pre class=" cm-s-solarized"><code><span class="cm-keyword">def</span><span> </span><span class="cm-def">transformIterable</span><span>(</span><span class="cm-variable-2">self</span><span>, </span><span class="cm-variable">result</span><span>, </span><span class="cm-variable">encoding</span><span>):</span><span>
</span><span>    </span><span class="cm-keyword">if</span><span> </span><span class="cm-variable">IPromises</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>):</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-variable">PromiseWorkerStreamIterator</span><span>(</span><span>
</span><span>            </span><span class="cm-variable">IPromises</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>), </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>, </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">request</span><span>.</span><span class="cm-property">response</span><span>)</span><span>
</span><span>    </span><span class="cm-keyword">else</span><span>:</span><span>
</span><span>        </span><span class="cm-keyword">return</span><span> </span><span class="cm-keyword">None</span></code></pre>
    </div>
</li>
<li>
<p>finally, we’d wrap the current Medusa channel in a way that instead
of publishing any data yet, a cloned request is queued for the
ZPublisher (similarly how retries are done after conflict errors),
but those cloned request and annotated to carry the resolved
futures:</p>
<div class="gatsby-highlight" data-language="python">
      <pre class=" cm-s-solarized"><code><span class="cm-keyword">def</span><span> </span><span class="cm-builtin">next</span><span>(</span><span class="cm-variable-2">self</span><span>):</span><span>
</span><span>   </span><span class="cm-keyword">if</span><span> </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_futures</span><span>:</span><span>
</span><span>       </span><span class="cm-variable">IFutures</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_zrequest</span><span>).</span><span class="cm-property">update</span><span>(</span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_futures</span><span>)</span><span>
</span><span>       </span><span class="cm-variable-2 error">self</span><span>.</span><span class="cm-property">_futures</span><span> </span><span class="cm-operator">=</span><span> {}  </span><span class="cm-comment"># mark consumed to raise StopIteration</span><span>

</span><span>       </span><span class="cm-keyword">from</span><span> </span><span class="cm-variable">ZServer</span><span>.</span><span class="cm-property">PubCore</span><span> </span><span class="cm-keyword">import</span><span> </span><span class="cm-variable">handle</span><span>
</span><span>       </span><span class="cm-variable error">handle</span><span>(</span><span class="cm-string">'Zope2'</span><span>, </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_zrequest</span><span>, </span><span class="cm-variable-2">self</span><span>.</span><span class="cm-property">_zrequest</span><span>.</span><span class="cm-property">response</span><span>)</span><span>
</span><span>   </span><span class="cm-keyword error">else</span><span>:</span><span>
</span><span>       </span><span class="cm-keyword">raise</span><span> </span><span class="cm-variable">StopIteration</span></code></pre>
    </div>
</li>
<li>
<p>now the add-on code in question would find the futures from request,
not issue any promises anymore and the request would result a normal
response pushed all the way to the browser, which initiated the
original request.</p>
</li>
</ul>
<p>I’m not sure yet, how good or bad idea this would be, but I’ve been
tinkering with a proof-of-concept implementation called
<a href="https://github.com/datakurre/experimental.promises">experimental.promises</a>
to figure it out.</p>
<p>Of course, there are limits and issues to be aware of. Handling the same
request twice is not free, which makes approach effective only when some
significant processing can be moved to be done outside the worker
threads. Also, because there may be other request between the first and
the second pass (freeing the worker to handle other request is the whole
point), the database may change between the passes (kind of breaking the
MVCC promise). Finally, currently it’s possible write the code always
set new promises and end into never ending loop.</p>
<p>Anyway, if you are interested to try out these approaches (at your own
risk, of course), feel free to ask more via Twitter or IRC.</p></div></div><hr style="margin-bottom:1.75rem"/><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2014/03/cross-browser-selenium-testing-with.html/">← <!-- -->Cross-Browser Selenium testing with Robot Framework and Sauce Labs</a></li><li><a rel="next" href="/2014/09/nix-expressions-as-executable-commands.html/">Nix expressions as executable commands<!-- --> →</a></li></ul></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2014/05/asynchronous-stream-iterators-and.html/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-8e352158238d7a981d99.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-97805cac34ee32fd2ff3.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-d702b3556e2e37664238.js\"],\"component---src-templates-blog-post-js\":[\"/component---src-templates-blog-post-js-db3b846139cc4b35992f.js\"],\"component---src-templates-follow-js\":[\"/component---src-templates-follow-js-48b9dd3d02ab9724ef8f.js\"],\"component---src-templates-like-js\":[\"/component---src-templates-like-js-8481525f17b37bf9ff44.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="1117cca6506347fc7992";</script><script src="/webpack-runtime-e10ad14bfe4fe997f9f6.js" async></script><script src="/framework-a3d1aa3677a1ff482f17.js" async></script><script src="/app-8e352158238d7a981d99.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>